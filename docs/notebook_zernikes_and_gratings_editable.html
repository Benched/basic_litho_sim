<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" href="./assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" href="./assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" href="./assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        resizeObserver.observe(obj.contentWindow.document.body);
      }
    </script>
    <marimo-filename hidden>notebook.py</marimo-filename>
    <marimo-mode data-mode='edit' hidden></marimo-mode>
    <marimo-version data-version='0.13.11' hidden></marimo-version>
    <marimo-user-config data-config='{"completion": {"activate_on_typing": true, "copilot": false}, "display": {"theme": "light", "code_editor_font_size": 14, "default_width": "medium", "cell_output": "above", "dataframes": "rich", "default_table_page_size": 10}, "formatting": {"line_length": 79}, "keymap": {"preset": "default", "overrides": {}}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "reactive_tests": true, "on_cell_change": "autorun", "watcher_on_save": "lazy", "output_max_bytes": 8000000, "std_stream_max_bytes": 1000000, "default_sql_output": "auto"}, "save": {"autosave": "off", "autosave_delay": 1000, "format_on_save": false}, "package_management": {"manager": "pip"}, "server": {"browser": "default", "follow_symlink": false}, "language_servers": {"pylsp": {"enabled": true, "enable_mypy": true, "enable_ruff": true, "enable_flake8": false, "enable_pydocstyle": false, "enable_pylint": false, "enable_pyflakes": false}}, "snippets": {"custom_paths": [], "include_default_snippets": true}}' data-overrides='{}' hidden></marimo-user-config>
    <marimo-app-config data-config='{"width": "medium", "sql_output": "auto"}' hidden></marimo-app-config>
    <marimo-server-token data-token='123' hidden></marimo-server-token>
    <title>notebook zernikes and gratings</title>
    <script type="module" crossorigin src="./assets/index-BR3wLmMq.js"></script>
    <link rel="stylesheet" crossorigin href="./assets/index-CQvPIadz.css">
  <marimo-wasm hidden=""></marimo-wasm>
    <script>
        if (window.location.protocol === 'file:') {
            alert('Warning: This file must be served by an HTTP server to function correctly.');
        }
    </script>
    
    <style>
        #save-button {
            display: none !important;
        }
        #filename-input {
            display: none !important;
        }
    </style>
    <marimo-code hidden="" data-show-code="false">import%20marimo%0A%0A__generated_with%20%3D%20%220.13.11%22%0Aapp%20%3D%20marimo.App(width%3D%22medium%22)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20import%20sys%0A%20%20%20%20import%20numpy%20as%20np%0A%20%20%20%20import%20matplotlib.pyplot%20as%20plt%0A%20%20%20%20import%20xarray%20as%20xr%0A%20%20%20%20return%20mo%2C%20np%2C%20plt%2C%20sys%2C%20xr%0A%0A%0A%40app.cell%0Aasync%20def%20_(sys)%3A%0A%20%20%20%20wheel_name%20%3D%20%22goodoptics-0.1.0-py3-none-any.whl%22%0A%20%20%20%20wheel_local%20%3D%20%22.%2Fdist%2F%22%20%2B%20wheel_name%0A%20%20%20%20wheel_remote%20%3D%20%22https%3A%2F%2Fbenched.github.io%2Fbasic_litho_sim%2F%22%20%2B%20wheel_name%0A%0A%20%20%20%20is_pyodide%20%3D%20%22pyodide%22%20in%20sys.modules%0A%0A%20%20%20%20if%20%22pyodide%22%20in%20sys.modules%3A%0A%20%20%20%20%20%20%20%20import%20micropip%0A%20%20%20%20%20%20%20%20await%20micropip.install(%22plotly%22)%0A%20%20%20%20%20%20%20%20await%20micropip.install(%22sympy%22)%0A%20%20%20%20%20%20%20%20await%20micropip.install(wheel_remote)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20import%20subprocess%2C%20pathlib%0A%20%20%20%20%20%20%20%20import%20os%0A%20%20%20%20%20%20%20%20wheel%20%3D%20wheel_local%20%23%20wheel_local%20if%20os.path.exists(wheel_local)%20else%20wheel_remote%0A%20%20%20%20%20%20%20%20subprocess.run(%5Bsys.executable%2C%20%22-m%22%2C%20%22pip%22%2C%20%22install%22%2C%20%22-q%22%2C%20wheel%5D%2C%20check%3DTrue)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20from%20goodoptics%20import%20zernikes%2C%20fourier%2C%20plot%2C%20shapes%0A%20%20%20%20return%20fourier%2C%20plot%2C%20shapes%2C%20zernikes%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20N%20%3D%20600%0A%20%20%20%20return%20(N%2C)%0A%0A%0A%40app.cell%0Adef%20_(N%2C%20zernikes)%3A%0A%20%20%20%20z2%20%3D%20zernikes.zernike(2)%0A%20%20%20%20z2.N%20%3D%20N%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20%23%20distortion%20%3D%20zernikes.zernike_aberration(%7B2%3A10%2C%204%3A180%2C%205%3A180%2C%207%3A-20%2C%209%3A30%7D%2C%20N%3DN)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(np%2C%20xr)%3A%0A%0A%20%20%20%20def%20grating_x_da(%0A%20%20%20%20%20%20%20%20total_area%3D100%2C%0A%20%20%20%20%20%20%20%20used_area%3D30%2C%0A%20%20%20%20%20%20%20%20line_width%3D1%2C%0A%20%20%20%20%20%20%20%20N%3D600%2C%0A%20%20%20%20%20%20%20%20overall_offset_x%3D0%2C%0A%20%20%20%20%20%20%20%20overall_offset_y%3D0%2C%0A%20%20%20%20)%3A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20Generate%20a%202D%20vertical%20grating%20pattern%20with%20perfectly%20aligned%2C%0A%20%20%20%20%20%20%20%20full-width%20stripes%20and%20no%20edge%20leftovers.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%23%20---%20Grid%20---%0A%20%20%20%20%20%20%20%20x%20%3D%20np.linspace(-total_area%2C%20total_area%2C%20N%2C%20endpoint%3DFalse)%0A%20%20%20%20%20%20%20%20y%20%3D%20np.linspace(-total_area%2C%20total_area%2C%20N%2C%20endpoint%3DFalse)%0A%20%20%20%20%20%20%20%20X%2C%20Y%20%3D%20np.meshgrid(x%2C%20y%2C%20indexing%3D%22ij%22)%0A%0A%20%20%20%20%20%20%20%20%23%20---%20Correct%20cutoff%20to%20nearest%20multiple%20of%20period%20(2*line_width)%20---%0A%20%20%20%20%20%20%20%20period%20%3D%202%20*%20line_width%0A%20%20%20%20%20%20%20%20full_extent%20%3D%20(used_area%20%2F%2F%20period)%20*%20period%0A%20%20%20%20%20%20%20%20cutoff%20%3D%20full_extent%20%2F%202%20%20%23%20symmetric%20half-width%0A%0A%20%20%20%20%20%20%20%20%23%20---%20Define%20shifted%20coordinates%20---%0A%20%20%20%20%20%20%20%20Xs%20%3D%20X%20-%20overall_offset_x%0A%20%20%20%20%20%20%20%20Ys%20%3D%20Y%20-%20overall_offset_y%0A%0A%20%20%20%20%20%20%20%20%23%20---%20Inside%20aperture%20---%0A%20%20%20%20%20%20%20%20inside%20%3D%20(np.abs(Xs)%20%3C%3D%20cutoff)%20%26%20(np.abs(Ys)%20%3C%3D%20used_area)%0A%0A%20%20%20%20%20%20%20%20%23%20---%20Periodic%20grating%20mask%20(modulo-based%2C%20robust%20to%20float%20rounding)%20---%0A%20%20%20%20%20%20%20%20local_x%20%3D%20(Xs%20%2B%20cutoff)%20%25%20(2%20*%20line_width)%0A%20%20%20%20%20%20%20%20line_mask%20%3D%20local_x%20%3C%20line_width%20%20%23%201st%20half%20%3D%20bright%20line%0A%0A%20%20%20%20%20%20%20%20%23%20---%20Final%20pattern%20---%0A%20%20%20%20%20%20%20%20pattern%20%3D%20np.where(inside%20%26%20line_mask%2C%201.0%2C%200.0)%0A%0A%20%20%20%20%20%20%20%20da%20%3D%20xr.DataArray(%0A%20%20%20%20%20%20%20%20%20%20%20%20pattern%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20coords%3D%7B%22x%22%3A%20x%2C%20%22y%22%3A%20y%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20dims%3D(%22x%22%2C%20%22y%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20attrs%3D%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22dx%22%3A%20(2%20*%20total_area%20%2F%20N)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22dy%22%3A%20(2%20*%20total_area%20%2F%20N)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22N%22%3A%20N%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22cutoff%22%3A%20cutoff%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22period%22%3A%20period%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20return%20da%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(shapes%2C%20xr)%3A%0A%20%20%20%20def%20grating_x(total_area%3D100%2C%20used_area%3D30%2C%20line_width%3D1%2C%20N%3D600%2C%20overall_offset_x%3D0%2C%20overall_offset_y%3D0)%3A%0A%20%20%20%20%20%20%20%20iterations%20%3D%20used_area%20%2F%2F%20line_width%0A%20%20%20%20%20%20%20%20lines%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20for%20i%20in%20range(iterations)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20offset_x%20%3D%20-used_area%20%2B%20%202*line_width*i%0A%20%20%20%20%20%20%20%20%20%20%20%20lines.append(shapes.top_hat_2d_da(N%2C%20N%2C%20overall_offset_x%2Boffset_x%2C%20overall_offset_x%2Boffset_x%2Bline_width%2Coverall_offset_y-used_area%2Coverall_offset_y%2Bused_area%2C%20-total_area%2C%20total_area%2C%20-total_area%2C%20total_area))%0A%20%20%20%20%20%20%20%20return%20xr.concat(lines%2C%20dim%3D%22i%22).sum('i')%0A%0A%20%20%20%20return%20(grating_x%2C)%0A%0A%0A%40app.cell%0Adef%20_(shapes%2C%20xr)%3A%0A%20%20%20%20def%20grating_y(total_area%3D100%2C%20used_area%3D30%2C%20line_width%3D1%2C%20N%3D600%2C%20overall_offset_x%3D0%2C%20overall_offset_y%3D0)%3A%0A%20%20%20%20%20%20%20%20iterations%20%3D%20used_area%20%2F%2F%20line_width%0A%20%20%20%20%20%20%20%20lines%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20for%20i%20in%20range(iterations)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20offset_y%20%3D%20-used_area%20%2B%20%202*line_width*i%0A%20%20%20%20%20%20%20%20%20%20%20%20lines.append(shapes.top_hat_2d_da(N%2C%20N%2Coverall_offset_x-used_area%2Coverall_offset_x%2Bused_area%2C%20overall_offset_y%2Boffset_y%2C%20overall_offset_y%2Boffset_y%2Bline_width%2C%20-total_area%2C%20total_area%2C%20-total_area%2C%20total_area))%0A%20%20%20%20%20%20%20%20return%20xr.concat(lines%2C%20dim%3D%22i%22).sum('i')%0A%20%20%20%20return%20(grating_y%2C)%0A%0A%0A%40app.cell%0Adef%20_(N%2C%20grating_x%2C%20grating_y)%3A%0A%20%20%20%20lines%20%3D%20grating_y(overall_offset_y%20%3D%20-40%2C%20N%20%3D%20N)%20%2B%20grating_x(overall_offset_y%20%3D%2040%2C%20N%3DN)%20%0A%20%20%20%20return%20(lines%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%20Gratings%20and%20their%20imaging%0A%20%20%20%20Starting%20with%20a%20basic%20usecase%20-%20horizontal%20and%20vertical%20lines%20we%20will%20show%20the%20impact%20of%20some%20imaging%20distortions.%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(lines%2C%20plt)%3A%0A%20%20%20%20plt.imshow(lines)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(fourier%2C%20lines%2C%20shapes)%3A%0A%20%20%20%20ft_lines_zeroed%20%3D%20shapes.zero_outside_radius(fourier.ft2d(lines)%2C%201.5)%0A%20%20%20%20return%20(ft_lines_zeroed%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22If%20we%20take%20a%20fouriertransform%20of%20such%20a%20structure%20-%20and%20limit%20the%20redius%20slightly%20-%20we%20still%20get%20a%20very%20good%20image%20of%20the%20original.%20The%20plots%20have%20a%20reduced%20density%20compared%20to%20the%20actual%20calculations.%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(ft_lines_zeroed%2C%20plot%2C%20shapes)%3A%0A%20%20%20%20plot.complex_surface(shapes.reduce_density(ft_lines_zeroed%2C%202%2C%202))%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(fourier%2C%20ft_lines_zeroed)%3A%0A%20%20%20%20image_lines%20%3D%20fourier.ft2d(ft_lines_zeroed)%0A%20%20%20%20return%20(image_lines%2C)%0A%0A%0A%40app.cell%0Adef%20_(image_lines%2C%20plot%2C%20shapes)%3A%0A%20%20%20%20plot.real_surface(shapes.reduce_density(abs(image_lines)%2C%202%2C%202))%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%20Zernikes%0A%20%20%20%20Aberations%20are%20added%20via%20zernikes%20in%20an%20additional%20exponent%20(explanation%20in%20a%20later%20update).%0A%0A%20%20%20%20Let's%20start%20with%20a%20simple%20case%20of%20some%20amount%20of%20Zernike%204%20-%20which%20results%20in%20a%20defocus.%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20max_zenike%20%3D%2025%0A%20%20%20%20return%20(max_zenike%2C)%0A%0A%0A%40app.cell%0Adef%20_(max_zenike%2C%20mo)%3A%0A%20%20%20%20zernike_sliders%3D%20%7Bi%20%3A%20mo.ui.slider(start%3D-40%2C%20stop%3D40%2C%20step%3D0.2%2C%20value%3D0%2C%20show_value%3DTrue%2C%20full_width%3DTrue)%20for%20i%20in%20range(2%2C%20max_zenike%2B1)%7D%0A%20%20%20%20return%20(zernike_sliders%2C)%0A%0A%0A%40app.cell%0Adef%20_(zernike_sliders)%3A%0A%20%20%20%20def%20split_into_columns(d%3A%20dict%2C%20ncols%3A%20int%20%3D%203)%3A%0A%20%20%20%20%20%20%20%20items%20%3D%20list(d.items())%0A%20%20%20%20%20%20%20%20total%20%3D%20len(items)%0A%20%20%20%20%20%20%20%20base%2C%20extra%20%3D%20divmod(total%2C%20ncols)%0A%0A%20%20%20%20%20%20%20%20columns%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20start%20%3D%200%0A%20%20%20%20%20%20%20%20for%20i%20in%20range(ncols)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20end%20%3D%20start%20%2B%20base%20%2B%20(1%20if%20i%20%3C%20extra%20else%200)%0A%20%20%20%20%20%20%20%20%20%20%20%20columns.append(items%5Bstart%3Aend%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20start%20%3D%20end%0A%20%20%20%20%20%20%20%20return%20columns%0A%0A%20%20%20%20columns%20%3D%20split_into_columns(zernike_sliders%2C%203)%0A%20%20%20%20return%20(split_into_columns%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20apply_button%20%3D%20mo.ui.button(value%3DTrue%2C%20label%3D%22apply%22)%0A%20%20%20%20return%20(apply_button%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%20Zernike%20sliders%0A%20%20%20%20Below%20you%20can%20use%20the%20zernike%20sliders%20to%20adjsut%20the%20image%20%0A%20%20%20%20interesting%20use-cases%3A%20%0A%0A%20%20%20%201.%20Z2%20%3D%204%0A%20%20%20%20%20%20%20%20*%20Z2%20is%20pure%20overlay%0A%20%20%20%20%20%20%20%20*%20Also%20try%20Z3%0A%20%20%20%202.%20Z4%20%3D%204%0A%20%20%20%20%20%20%20%20*%20Z4%20changes%20the%20focus%20for%20all%20lines%0A%20%20%20%203.%20Z4%20%3D%204%20and%20Z5%20%3D%204%0A%20%20%20%20%20%20%20%20*%20Z4%20changes%20the%20focus%20for%20all%20lines%2C%20Z5%20changes%20the%20focus%20-%20but%20it%20depends%20on%20orientation%0A%20%20%20%204.%20Z4%20%3D%204%20and%20Z5%20%3D%20-4%0A%20%20%20%20%20%20%20%20*%20Notice%20how%20this%20is%20the%20opposite%20of%20the%20previous%20experiment%3F%0A%20%20%20%205.%20Z7%20%3D%204%0A%20%20%20%20%20%20%20%20*%20Coma%20is%20an%20overlay%20effect%20-%20and%20feature%20dependent%0A%20%20%20%20%20%20%20%20*%20Also%20try%20Z8%0A%0A%20%20%20%20For%20large%20overlay%20effects%20the%20periodic%20boundary%20becomes%20visible%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(apply_button%2C%20mo%2C%20split_into_columns%2C%20zernike_sliders)%3A%0A%20%20%20%20sliders_reshaped%20%3D%20split_into_columns(zernike_sliders)%0A%20%20%20%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bmo.vstack(%5Bmo.hstack(%5Bi%5B0%5D%2C%20i%5B1%5D%5D)%20for%20i%20in%20col%5D)%20for%20col%20in%20sliders_reshaped%5D)%2C%20apply_button%0A%20%20%20%20%5D)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(apply_button%2C%20zernike_sliders)%3A%0A%20%20%20%20v%20%3D%20apply_button.value%0A%20%20%20%20zernike_values%20%3D%20%7Bk%3A%20v.value%20for%20k%2C%20v%20in%20zernike_sliders.items()%7D%0A%20%20%20%20return%20(zernike_values%2C)%0A%0A%0A%40app.cell%0Adef%20_(lines%2C%20zernike_values%2C%20zernikes)%3A%0A%20%20%20%20distortion%20%3D%20zernikes.zernike_aberration(zernike_values%2C%20N%3Dlen(lines))%0A%20%20%20%20return%20(distortion%2C)%0A%0A%0A%40app.cell%0Adef%20_(fourier%2C%20np%2C%20shapes%2C%20zernikes)%3A%0A%20%20%20%20def%20fourier_optics(mask%2C%20distortion%3DNone%2C%20radius%3DNone)%3A%0A%20%20%20%20%20%20%20%20ft%20%3D%20fourier.ft2d(mask)%0A%20%20%20%20%20%20%20%20if%20radius%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20radius%20%3D%20float(ft.x.max())%0A%20%20%20%20%20%20%20%20ft_radius_applied%20%3D%20shapes.zero_outside_radius(ft%2C%20radius)%0A%20%20%20%20%20%20%20%20if%20distortion%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(distortion%2C%20dict)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20distortion%20%3D%20zernikes.zernike_aberration(distortion%2C%20N%3Dlen(mask.x))%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20distortion.N%20%3D%20len(mask.x)%0A%20%20%20%20%20%20%20%20%20%20%20%20distored_ft%20%3D%20ft_radius_applied%20*%20np.exp(complex(0%2C%201)*2*np.pi*%20distortion.sample())%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20fourier.ft2d(distored_ft)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20fourier.ft2d(ft_radius_applied)%0A%20%20%20%20return%20(fourier_optics%2C)%0A%0A%0A%40app.cell%0Adef%20_(distortion%2C%20fourier_optics%2C%20lines)%3A%0A%20%20%20%20lines_imaged%20%3D%20fourier_optics(lines%2C%20distortion%3Ddistortion%2C%20radius%20%3D%20None)%0A%20%20%20%20return%20(lines_imaged%2C)%0A%0A%0A%40app.cell%0Adef%20_(lines_imaged%2C%20plt)%3A%0A%20%20%20%20plt.imshow(abs(lines_imaged))%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(lines_imaged%2C%20plot%2C%20shapes)%3A%0A%20%20%20%20plot.real_surface(shapes.reduce_density(abs(lines_imaged)%2C%202%2C%202))%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%20Quick%20demo%20of%20a%20small%20radius%20%0A%20%20%20%20The%20individual%20lines%20fall%20below%20the%20threshold%20of%20what%20can%20be%20imaged%20-%20they%20all%20melt%20into%20the%20square%20blocks%20that%20are%20then%20the%20same%20total%20volume%20(and%20therefore%20half%20the%20height)%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(fourier_optics%2C%20lines%2C%20plot%2C%20shapes)%3A%0A%20%20%20%20plot.real_surface(%0A%20%20%20%20%20%20%20%20shapes.reduce_density(%0A%20%20%20%20%20%20%20%20%20%20%20%20abs(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fourier_optics(lines%2C%20radius%3D.2)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%203%2C%203)%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A</marimo-code></head>
  <body>
    <div id="root"></div>
  </body>
</html>
